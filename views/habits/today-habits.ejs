<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Habit Tracker</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      body {
        position: relative;
        display: flex;
        flex-direction: column;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #fff;
        padding: 20px;
        padding-top: 60px;
        width: calc(100% - 4rem);
        max-width: 1000px;
        margin: auto;
      }
      .profile-pic {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
      }

      .container {
        padding: 0 !important;
        border: none;
      }

      .title {
        font-size: 2.5rem;
        margin: 1rem 0 6.4rem;
        text-align: center;
      }

      .weekdays {
        display: flex;
        justify-content: space-between;
        height: 85px;
        gap: 7px;
        background: #f0f0f0;
        padding: 0.5rem;
        border-radius: 24px;
        margin-bottom: 2.8rem;
      }

      .weekday {
        flex: 1;
        text-align: center;
        justify-content: center;
        align-items: center;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        padding: 0.5rem 0.25rem;
        border-radius: 16px;
        transition: 0.02s;
      }

      .weekday:hover {
        background: #e0e0e0;
      }

      .weekday.today {
        background: #d4d4d4;
        color: black;
      }

      .weekday.active {
        background: pink;
        color: white;
      }

      .weekday-name {
        font-weight: bold;
        font-size: 0.9rem;
      }

      .weekday-date {
        font-size: 0.75rem;
        color: #444;
      }

      .cardDay {
        display: none;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(56, 56, 56, 0.05);
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .cardDay.active {
        display: block;
      }

      .dayHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      input[type="checkbox"] {
        transform: scale(1.2);
        margin-right: 10px;
        cursor: pointer;
      }

      label {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .records-btn {
        position: fixed;
        bottom: 1.5rem;
        left: 1.5rem;
        width: 100px;
        height: 50px;
        background-color: pink;
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 2rem;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }
      .add-btn {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        width: 52px;
        height: 52px;
        background-color: pink;
        color: white;
        font-size: 2rem;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        transition: background 0.3s;
      }

      .records-btn:hover,
      .add-btn:hover {
        background-color: pink;
      }

      .progress-container {
        width: 100%;
        height: 20px;
        background: #eee;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .progress-bar {
        height: 100%;
        width: 0%;
      }
      .profile-pic {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="profile-pic">
      <img src="/images/<%= pfp %>" class="pfp" />
    </div>
    <div class="container">
      <h1 class="title">Your Weekly Habits</h1>

      <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>

      <div class="weekdays">
        <% week.forEach((day, index) => { %>
        <div
          class="weekday <%= day.isToday ? 'today' : '' %>"
          data-index="<%= index %>"
        >
          <div class="weekday-name"><%= day.dayName.slice(0, 3) %></div>
          <div class="weekday-date"><%= new Date(day.date).getDate() %></div>
        </div>
        <% }) %>
      </div>

      <% week.forEach((day, index) => { %>
      <div class="cardDay" id="card-<%= index %>">
        <div class="dayHeader">
          <h2><%= day.dayName %></h2>
          <p><%= new Date(day.date).toDateString() %></p>
        </div>

        <% if (day.habits.length === 0) { %>
        <p>No habits for this day</p>
        <% } else { %> <% day.habits.forEach(habit => { %>
        <form
          method="POST"
          action="/habits/check-day"
          onsubmit="saveCurrentDay()"
        >
          <input type="hidden" name="habitId" value="<%= habit._id %>" />
          <input
            type="hidden"
            name="date"
            value="<%= new Date(day.date).toDateString() %>"
          />
          <label>
            <input type="checkbox" name="isChecked" <%= habit.isChecked ?
            'checked' : '' %> onchange="this.form.submit();" /> <%= habit.name
            %>
          </label>
        </form>
        <% }) %> <% } %>
      </div>
      <% }) %>
    </div>

    <div class="bottom-bttns">
      <button
        class="records-btn"
        onclick="window.location.href='/habits/records'"
      >
        Calendar
      </button>
      <button onclick="location.href='/habits/add-habit'" class="add-btn">
        +
      </button>
    </div>

    <script>
      function showDay(index) {
        localStorage.setItem("selectedDayIndex", index);

        document.querySelectorAll(".cardDay").forEach((card) => {
          card.classList.remove("active");
        });
        document.getElementById("card-" + index).classList.add("active");

        document.querySelectorAll(".weekday").forEach((el) => {
          el.classList.remove("active");
        });
        document
          .querySelector(`.weekday[data-index="${index}"]`)
          ?.classList.add("active");
      }

      function updateProgressBar() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const progressBar = document.getElementById("progress-bar");

        let checkedCount = 0;
        checkboxes.forEach((cb) => cb.checked && checkedCount++);

        const percentage = checkboxes.length
          ? (checkedCount / checkboxes.length) * 100
          : 0;
        progressBar.style.width = percentage + "%";
      }

      // Init
      window.addEventListener("DOMContentLoaded", () => {
        const savedIndex = localStorage.getItem("selectedDayIndex");
        const fallbackIndex =
          document
            .querySelector(".weekday.today")
            ?.getAttribute("data-index") || "0";
        const initialIndex = savedIndex ?? fallbackIndex;

        showDay(initialIndex);
        updateProgressBar();

        document.querySelectorAll(".weekday").forEach((el) => {
          el.addEventListener("click", () => {
            const index = el.getAttribute("data-index");
            showDay(index);
          });
        });
      });
    </script>
  </body>
</html>
